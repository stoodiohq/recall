# Recall Development Session - January 6, 2026

## Summary
Fixed critical issues in the Stripe payment flow and onboarding process to enable the full signup → payment → setup experience.

---

## Issues Fixed

### 1. Auth Code Exchange Failing (Stateless Workers Issue)
**Problem:** After GitHub OAuth, the auth code exchange was failing with "Invalid or expired authorization code"

**Root Cause:** Auth codes were stored in an in-memory JavaScript `Map`, but Cloudflare Workers are stateless - each request can hit a different isolate where the Map is empty.

**Fix:**
- Created `auth_codes` table in D1 database
- Updated OAuth callback to store codes in D1 instead of memory
- Updated `/auth/exchange` endpoint to read from D1
- Codes auto-expire after 5 minutes and are deleted after use

**Files Changed:**
- `cloud/src/index.ts` - OAuth flow and auth code exchange

---

### 2. Stripe Price Mismatch ($12 vs $10)
**Problem:** Website showed $10/month but Stripe had $12/month configured

**Fix:**
- Created new Stripe price at $10/month: `price_1Smo3zGXjDBivCg0x35t9VDd`
- Updated `cloud/wrangler.stoodio.toml` with new STRIPE_PRICE_ID
- Updated `web/src/components/Pricing.tsx` to show $10 (with $8 annual)
- Updated `web/src/app/onboarding/page.tsx` pricing display

---

### 3. Onboarding Flow Skipping Stripe Checkout
**Problem:** Selecting a paid plan (Team/Enterprise) went directly to repo selection instead of Stripe checkout

**Root Cause:** The API call to `/onboarding/complete` only happened AFTER repo selection (on the final "Complete" button), but users expected to pay immediately after selecting a plan.

**Fix:**
- Modified `handlePlanSubmit()` in onboarding page to:
  - For paid plans: Call API immediately → redirect to Stripe checkout
  - For free plans: Continue to repo selection as before
- Created `/onboarding/success` page to handle post-checkout flow
- Success page refreshes user data, initializes repos, then redirects to dashboard

**Files Changed:**
- `web/src/app/onboarding/page.tsx` - Plan submit flow
- `web/src/app/onboarding/success/page.tsx` - New success page (created)

---

### 4. Stripe Webhook Not Creating Teams
**Problem:** After successful Stripe payment, the webhook failed silently and no team was created

**Root Cause:** The `teams` table was missing the `subscription_status` column that the webhook INSERT statement required.

**Fix:**
- Added `subscription_status` column to teams table:
  ```sql
  ALTER TABLE teams ADD COLUMN subscription_status TEXT DEFAULT 'active';
  ```
- Manually created team for user who had already paid

**Database Changes:**
- Added `subscription_status` column to `teams` table
- Created `auth_codes` table for OAuth flow
- Created `onboarding_sessions` table for storing data between checkout steps

---

### 5. Onboarding Session Storage for Webhook
**Problem:** Webhook needed to know which repos user selected, but that data wasn't available after Stripe redirect

**Fix:**
- Created `onboarding_sessions` table to store:
  - User profile data (role, company, team_size)
  - Team name and plan
  - Selected repos (JSON)
  - Expiration timestamp (24 hours)
- Frontend saves session before Stripe redirect
- Webhook looks up session by ID (stored in subscription metadata)
- Session deleted after successful team creation

**Files Changed:**
- `cloud/src/index.ts` - Onboarding endpoint and webhook handler

---

## New Flow (After Fixes)

### Paid Plans (Team/Enterprise):
1. User fills out profile → Continue
2. User selects Team ($10) plan → Continue
3. **API creates onboarding session, returns Stripe checkout URL**
4. **User redirected to Stripe checkout**
5. User completes payment with test card
6. **Stripe webhook fires:**
   - Looks up onboarding session
   - Creates team with Stripe IDs
   - Enables selected repos
   - Marks onboarding complete
7. User redirected to success page
8. Success page redirects to dashboard/repos

### Free Plans:
1. User fills out profile → Continue
2. User selects Free plan → Continue
3. User selects repos → Complete
4. API creates team and enables repos
5. Redirect to dashboard

---

## Database Schema Changes

### New Table: `auth_codes`
```sql
CREATE TABLE auth_codes (
  code TEXT PRIMARY KEY,
  jwt TEXT NOT NULL,
  expires_at INTEGER NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

### New Table: `onboarding_sessions`
```sql
CREATE TABLE onboarding_sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  role TEXT,
  company TEXT,
  team_size TEXT,
  team_name TEXT,
  plan TEXT,
  seats INTEGER,
  selected_repos TEXT,  -- JSON array
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  expires_at INTEGER
);
```

### Modified Table: `teams`
```sql
ALTER TABLE teams ADD COLUMN subscription_status TEXT DEFAULT 'active';
```

---

## Files Modified

### Backend (`cloud/`)
- `src/index.ts`
  - OAuth callback: Store auth codes in D1
  - `/auth/exchange`: Read auth codes from D1
  - `/onboarding/complete`: Handle paid vs free plans differently
  - Stripe webhook: Look up onboarding session, create team with repos

- `wrangler.stoodio.toml`
  - Updated STRIPE_PRICE_ID to $10/month price

### Frontend (`web/`)
- `src/app/onboarding/page.tsx`
  - `handlePlanSubmit()`: Redirect to Stripe for paid plans
  - Price display updated to $10

- `src/app/onboarding/success/page.tsx` (NEW)
  - Handles post-checkout flow
  - Waits for webhook to process
  - Initializes repos
  - Redirects to dashboard

- `src/components/Pricing.tsx`
  - Updated price from $12 to $10/month
  - Updated annual from $10 to $8/seat

---

## Configuration

### Stripe (Test Mode)
- **Product:** Recall Team Standard (`prod_TjwA4wUcSPrNlb`)
- **Price:** $10/month (`price_1Smo3zGXjDBivCg0x35t9VDd`)
- **Webhook URL:** `https://api.recall.team/webhooks/stripe`
- **Webhook Events:**
  - `checkout.session.completed`
  - `customer.subscription.updated`
  - `customer.subscription.deleted`

### Test Card
- Number: `4242 4242 4242 4242`
- Expiry: Any future date
- CVC: Any 3 digits

---

## Remaining Issues / TODO

1. **Live Logs Setup** - Need persistent logging solution for debugging production issues

2. **Dashboard Step Detection** - Steps 2 & 3 completion detection should be verified:
   - Step 2: Has repos enabled
   - Step 3: Has MCP connection

3. **Webhook Reliability** - Consider adding:
   - Retry logic for failed webhooks
   - Logging to external service
   - Alert on webhook failures

4. **Error Handling** - Add user-facing error messages when:
   - Stripe checkout fails
   - Webhook processing fails
   - Team creation fails

---

## Deployments

- **Backend:** Deployed to Cloudflare Workers via `wrangler deploy --config wrangler.stoodio.toml`
- **Frontend:** Deployed to Cloudflare Pages via `wrangler pages deploy`
- **Database:** D1 database `recall-db` on Stoodio account

---

## Testing Notes

After all fixes, the complete flow was tested:
1. ✅ GitHub OAuth login works
2. ✅ Auth code exchange works (D1 storage)
3. ✅ Onboarding profile step works
4. ✅ Plan selection redirects to Stripe (for paid)
5. ✅ Stripe checkout completes successfully
6. ⚠️ Webhook failed initially (missing column) - fixed
7. ✅ Team manually created after schema fix
8. ⏳ Repo selection and CLI setup steps pending verification
